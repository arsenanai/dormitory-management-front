# .gitlab-ci.yml for crm-front (Vue.js)

stages:
  - test
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG

# This job runs your Vitest unit tests.
test:
  stage: test
  image: node:18-alpine
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
  before_script:
    - npm install
  script:
    # The command is taken from your package.json
    - npm run test:unit

# This job builds a production-ready Docker image and pushes it to the GitLab Container Registry.
build_image:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building production Docker image..."
    # Your README indicates the Dockerfile uses APP_ENV and NODE_ENV to select the build target.
    # We build the 'production' target.
    - >
      docker build
      --build-arg APP_ENV=production
      --build-arg NODE_ENV=production
      --build-arg VITE_API_BASE_URL=https://dorm.sdu.edu.kz:8000/api
      -t $IMAGE_TAG .
    - echo "Pushing Docker image to registry..."
    - docker push $IMAGE_TAG
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

# This job deploys the new image by SSHing into your server and running docker-compose commands.
deploy_production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - ssh-keyscan -H "$DEPLOY_SERVER_IP" >> ~/.ssh/known_hosts
  script:
    - echo "Deploying to production server..."
    # This script assumes your docker-compose service is named 'frontend' as per your README
    - >
      ssh $DEPLOY_USER@$DEPLOY_SERVER_IP "
      cd $DEPLOY_COMPOSE_PATH &&
      docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY &&
      docker pull $IMAGE_TAG &&
      docker-compose up -d --no-deps frontend &&
      echo 'Deployment complete'
      "
  environment:
    name: production
    url: https://dorm.sdu.edu.kz # As per your README
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'